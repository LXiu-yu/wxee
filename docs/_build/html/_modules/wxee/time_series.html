

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>wxee.time_series &mdash; wxee  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> wxee
          

          
          </a>

          
            
            
              <div class="version">
                0.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../wxee.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Developer Guide</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">wxee</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>wxee.time_series</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for wxee.time_series</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">ee</span>  <span class="c1"># type: ignore</span>

<span class="kn">from</span> <span class="nn">wxee.climatology</span> <span class="kn">import</span> <span class="n">Climatology</span>
<span class="kn">from</span> <span class="nn">wxee.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_climatology_frequency</span><span class="p">,</span>
    <span class="n">get_interpolation_method</span><span class="p">,</span>
    <span class="n">get_time_frequency</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">wxee.utils</span> <span class="kn">import</span> <span class="n">_normalize</span>


<div class="viewcode-block" id="TimeSeries"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries">[docs]</a><span class="k">class</span> <span class="nc">TimeSeries</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">imagecollection</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An image collection of chronological images.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The :code:`system:time_start` of first chronological image in the collection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ee.Date</span>
<span class="sd">            The start time of the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_min</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The :code:`system:time_start` of last chronological image in the collection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ee.Date</span>
<span class="sd">            The end time of the collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_max</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>

<div class="viewcode-block" id="TimeSeries.interval"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.interval">[docs]</a>    <span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Compute the mean time interval between images in the time series.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit : str, default &quot;day&quot;</span>
<span class="sd">            The unit to return the time interval in. One of &quot;minute&quot;, &quot;hour&quot;, &quot;day&quot;, &quot;week&quot;, &quot;month&quot;, &quot;year&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ee.Number</span>
<span class="sd">            The mean time interval between images.</span>

<span class="sd">        Warning</span>
<span class="sd">        -------</span>
<span class="sd">        Calculating the interval of very large collections may exceed memory limits. If this happens, try selecting only</span>
<span class="sd">        a portion of the collection dates.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; ts = wxee.TimeSeries(&quot;COPERNICUS/S2_SR&quot;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = ts.filterBounds(ee.Geometry.Point([-105.787, 38.753]))</span>
<span class="sd">        &gt;&gt;&gt; imgs.interval(&quot;day&quot;).getInfo()</span>
<span class="sd">        5.03</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">())</span></div>

<div class="viewcode-block" id="TimeSeries.describe"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.describe">[docs]</a>    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;day&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate and print descriptive statistics about the Time Series such as the ID, start and end dates, and time between images.</span>
<span class="sd">        This requires pulling data from the server, so it may run slowly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unit : str, default &quot;day&quot;</span>
<span class="sd">            The unit to return the time interval in. One of &quot;second&quot;, &quot;minute&quot;, &quot;hour&quot;, &quot;day&quot;, &quot;week&quot;, &quot;month&quot;, &quot;year&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

        <span class="c1"># Pulling min and max out of the stats is slightly faster than using `aggregate_min` and `aggregate_max` separately</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_stats</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>
        <span class="n">start_millis</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">))</span>
        <span class="n">end_millis</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">))</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">start_millis</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd HH:mm:ss z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">end_millis</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;yyyy-MM-dd HH:mm:ss z&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

        <span class="c1"># Calculating the interval using the start and end we already pulled is slightly faster than calculating the interval</span>
        <span class="c1"># from scratch.</span>
        <span class="n">mean_interval</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">end_millis</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">start_millis</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">getInfo</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Images: </span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Start date: </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">End date: </span><span class="si">{</span><span class="n">end</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Mean interval: </span><span class="si">{</span><span class="n">mean_interval</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">s&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TimeSeries.aggregate_time"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.aggregate_time">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimeSeries&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Aggregate the collection over the time dimension to a specified frequency. This method can only be used to go from</span>
<span class="sd">        small time frequencies to larger time frequencies, such as hours to days, not vice-versa. If the resampling frequency is smaller</span>
<span class="sd">        than the time between images, un-aggregated images will be returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : str</span>
<span class="sd">            The time frequency to aggregate to. One of &#39;year&#39;, &#39;month&#39; &#39;week&#39;, &#39;day&#39;, &#39;hour&#39;.</span>
<span class="sd">        reducer : ee.Reducer, optional</span>
<span class="sd">            The reducer to apply when aggregating over time. If none is provided, ee.Reducer.mean() will be used.</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the aggregated images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_mean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TimeSeries</span>
<span class="sd">            The input image collection aggregated to the specified time frequency.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If an invalid frequency is passed.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; ts_hourly = wxee.TimeSeries(&quot;NOAA/NWS/RTMA&quot;)</span>
<span class="sd">        &gt;&gt;&gt; daily_max = ts_hourly.aggregate_time(frequency=&quot;day&quot;, reducer=ee.Reducer.max())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ee.Reducer can&#39;t be used without initializing ee (see https://github.com/google/earthengine-api/issues/164),</span>
        <span class="c1"># so set the default reducer explicitly. This is also why the type hint above is set to Any.</span>
        <span class="n">reducer</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">reducer</span> <span class="k">else</span> <span class="n">reducer</span>
        <span class="n">original_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:id&quot;</span><span class="p">)</span>

        <span class="n">get_time_frequency</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">resample_step</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Resample one time step in the given unit from a specified start time.&quot;&quot;&quot;</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="n">resampled</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">reducer</span><span class="p">)</span>
            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span>
                <span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">(),</span> <span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">resampled</span> <span class="o">=</span> <span class="n">resampled</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;system:time_start&quot;</span><span class="p">:</span> <span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;system:time_end&quot;</span><span class="p">:</span> <span class="n">imgs</span><span class="o">.</span><span class="n">wx</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_end&quot;</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">keep_bandnames</span><span class="p">:</span>
                <span class="n">resampled</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">resampled</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">())</span>

            <span class="c1"># If the resampling step falls between images, just return null</span>
            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">resampled</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">start_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_steps_at_frequency</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TimeSeries</span><span class="p">(</span><span class="n">start_times</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">resample_step</span><span class="p">,</span> <span class="n">dropNulls</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="s2">&quot;system:id&quot;</span><span class="p">,</span> <span class="n">original_id</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_generate_steps_at_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ee.List[ee.Date]&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a list of start dates that would split the time series into a given frequency. For example, a time series of daily</span>
<span class="sd">        data at monthly frequency would return the start date of monthly periods starting from the first day.</span>

<span class="sd">        In the example above, this is done by calculating the number of months that cover the time series and iteratively advancing</span>
<span class="sd">        that many steps from the start time of the time series. This means that if the time series does not start on the first day of</span>
<span class="sd">        a month, the steps will not line up with calendar months but will instead represent month-long groups of contiguous days.</span>

<span class="sd">        A minimum of 1 step will be returned even if the time series period is smaller than the frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">get_time_frequency</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="n">n_steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">steps</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">frequency</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_calculate_climatology</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">climatology_reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Climatology</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate a climatology image collection with a given frequency and reducer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        climatology_reducer: Optional[ee.Reducer]</span>
<span class="sd">            The climatological reducer to apply to aggregated images. In most cases, this will be ee.Reducer.mean</span>
<span class="sd">            or ee.Reducer.stdDev for generating climatological means and standard deviations, respectively.</span>
<span class="sd">        frequency : str</span>
<span class="sd">            The name of the time frequency. One of &quot;day&quot;, &quot;month&quot;.</span>
<span class="sd">        reducer : Optional[ee.Reducer]</span>
<span class="sd">            The reducer to apply when aggregating over time, e.g. aggregating hourly data to daily for a daily</span>
<span class="sd">            climatology. If the data is already in the temporal scale of the climatology, e.g. creating a daily</span>
<span class="sd">            climatology from daily data, the reducer will have no effect.</span>
<span class="sd">        start : Optional[int]</span>
<span class="sd">            The start coordinate in the time frequency to include in the climatology, e.g. 1 for January if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 1 for both &quot;day&quot; and &quot;month&quot;.</span>
<span class="sd">        end : Optional[int]</span>
<span class="sd">            The end coordinate in the time frequency to include in the climatology, e.g. 8 for August if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 366 for &quot;day&quot; or 12 for &quot;month&quot;</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the aggregated images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_mean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.climatology.Climatology</span>
<span class="sd">            The climatological collection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reducer</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">reducer</span> <span class="k">else</span> <span class="n">reducer</span>

        <span class="n">freq</span> <span class="o">=</span> <span class="n">get_climatology_frequency</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span> <span class="k">else</span> <span class="n">start</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">freq</span><span class="o">.</span><span class="n">end</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">end</span> <span class="k">else</span> <span class="n">end</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;wx:</span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">def</span> <span class="nf">reduce_frequency</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">String</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
            <span class="sd">&quot;&quot;&quot;Apply a mean reducer over a time frequency, returning None if no images fall within the time window.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            x : ee.String</span>
<span class="sd">                The time coordinate to reduce, such as &quot;1&quot; for January.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">filterMetadata</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">reduced</span> <span class="o">=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">climatology_reducer</span><span class="p">)</span>
            <span class="c1"># Retrieve the time from the image instead of using x because I need a formatted</span>
            <span class="c1"># string for concatenating into the system:id later.</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">freq</span><span class="o">.</span><span class="n">date_format</span>
            <span class="p">)</span>
            <span class="n">reduced</span> <span class="o">=</span> <span class="n">reduced</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;wx:dimension&quot;</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="s2">&quot;wx:coordinate&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>

            <span class="n">geom</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
            <span class="c1"># Reducing makes images unbounded, so re-clip bounded images</span>
            <span class="n">reduced</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">isUnbounded</span><span class="p">(),</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">reduced</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">geom</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">keep_bandnames</span><span class="p">:</span>
                <span class="n">reduced</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">reduced</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">bandNames</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">reduced</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_time</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">keep_bandnames</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">img</span><span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">prop</span><span class="p">,</span>
                <span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                    <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">freq</span><span class="o">.</span><span class="n">date_format</span>
                    <span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">coord_list</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">sequence</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

        <span class="n">clim</span> <span class="o">=</span> <span class="n">Climatology</span><span class="p">(</span>
            <span class="n">coord_list</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">reduce_frequency</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">dropNulls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">clim</span> <span class="o">=</span> <span class="n">clim</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:id&quot;</span><span class="p">))</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">clim</span><span class="o">.</span><span class="n">reducer</span> <span class="o">=</span> <span class="n">reducer</span>

        <span class="k">return</span> <span class="n">clim</span>

<div class="viewcode-block" id="TimeSeries.climatology_mean"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.climatology_mean">[docs]</a>    <span class="k">def</span> <span class="nf">climatology_mean</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Climatology</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate a mean climatology image collection with a given frequency.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : str</span>
<span class="sd">            The name of the time frequency. One of &quot;day&quot;, &quot;month&quot;.</span>
<span class="sd">        reducer : Optional[ee.Reducer]</span>
<span class="sd">            The reducer to apply when aggregating over time, e.g. aggregating hourly data to daily for a daily</span>
<span class="sd">            climatology. If the data is already in the temporal scale of the climatology, e.g. creating a daily</span>
<span class="sd">            climatology from daily data, the reducer will have no effect.</span>
<span class="sd">        start : Optional[int]</span>
<span class="sd">            The start coordinate in the time frequency to include in the climatology, e.g. 1 for January if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 1 for both &quot;day&quot; and &quot;month&quot;.</span>
<span class="sd">        end : Optional[int]</span>
<span class="sd">            The end coordinate in the time frequency to include in the climatology, e.g. 8 for August if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 366 for &quot;day&quot; or 12 for &quot;month&quot;</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the aggregated images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_mean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.climatology.Climatology</span>
<span class="sd">            The climatological mean collection.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; collection = ee.ImageCollection(&quot;IDAHO_EPSCOR/GRIDMET&quot;)</span>
<span class="sd">        &gt;&gt;&gt; collection = collection.filterDate(&quot;1980&quot;, &quot;2000&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ts = wxee.TimeSeries(collection)</span>
<span class="sd">        &gt;&gt;&gt; daily_max = ts.climatology_mean(frequency=&quot;day&quot;, reducer=ee.Reducer.max())</span>
<span class="sd">        &gt;&gt;&gt; daily_max.size().getInfo()</span>
<span class="sd">        366</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean_clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_climatology</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">keep_bandnames</span>
        <span class="p">)</span>
        <span class="n">mean_clim</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>

        <span class="k">return</span> <span class="n">mean_clim</span></div>

<div class="viewcode-block" id="TimeSeries.climatology_std"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.climatology_std">[docs]</a>    <span class="k">def</span> <span class="nf">climatology_std</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">end</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Climatology</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate a standard deviation climatology image collection with a given frequency.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : str</span>
<span class="sd">            The name of the time frequency. One of &quot;day&quot;, &quot;month&quot;.</span>
<span class="sd">        reducer : Optional[ee.Reducer]</span>
<span class="sd">            The reducer to apply when aggregating over time, e.g. aggregating hourly data to daily for a daily</span>
<span class="sd">            climatology. If the data is already in the temporal scale of the climatology, e.g. creating a daily</span>
<span class="sd">            climatology from daily data, the reducer will have no effect.</span>
<span class="sd">        start : Optional[int]</span>
<span class="sd">            The start coordinate in the time frequency to include in the climatology, e.g. 1 for January if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 1 for both &quot;day&quot; and &quot;month&quot;.</span>
<span class="sd">        end : Optional[int]</span>
<span class="sd">            The end coordinate in the time frequency to include in the climatology, e.g. 8 for August if the</span>
<span class="sd">            frequency is &quot;month&quot;. If none is provided, the default will be 366 for &quot;day&quot; or 12 for &quot;month&quot;</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the aggregated images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_stdDev.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.climatology.Climatology</span>
<span class="sd">            The climatological standard deviation collection.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; collection = ee.ImageCollection(&quot;IDAHO_EPSCOR/GRIDMET&quot;)</span>
<span class="sd">        &gt;&gt;&gt; collection = collection.filterDate(&quot;1980&quot;, &quot;2000&quot;)</span>
<span class="sd">        &gt;&gt;&gt; ts = wxee.TimeSeries(collection)</span>
<span class="sd">        &gt;&gt;&gt; daily_max = ts.climatology_std(frequency=&quot;day&quot;, reducer=ee.Reducer.max())</span>
<span class="sd">        &gt;&gt;&gt; daily_max.size().getInfo()</span>
<span class="sd">        366</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mean_clim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_climatology</span><span class="p">(</span>
            <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">stdDev</span><span class="p">(),</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">keep_bandnames</span>
        <span class="p">)</span>
        <span class="n">mean_clim</span><span class="o">.</span><span class="n">statistic</span> <span class="o">=</span> <span class="s2">&quot;standard deviation&quot;</span>

        <span class="k">return</span> <span class="n">mean_clim</span></div>

<div class="viewcode-block" id="TimeSeries.climatology_anomaly"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.climatology_anomaly">[docs]</a>    <span class="k">def</span> <span class="nf">climatology_anomaly</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Climatology</span><span class="p">,</span>
        <span class="n">std</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Climatology</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimeSeries&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Calculate climatological anomalies for the time series. The frequency and reducer will be the same as those</span>
<span class="sd">        used in the :code:`mean` climatology. Standardized anomalies can be calculated by providing a climatological standard</span>
<span class="sd">        deviation as :code:`std`.</span>

<span class="sd">        A climatological anomaly is calculated as the difference between the climatological mean and a given observation.</span>
<span class="sd">        For standardized anomalies, that difference is divided by the climatological standard deviation. Standardized</span>
<span class="sd">        anomalies represent unitless measurements of how many standard deviations an observation was from the climatological</span>
<span class="sd">        mean, and therefore allow easy comparisons between variables.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Climatological anomalies are generally calculated using long-term climatological normals (e.g. 30 years). If</span>
<span class="sd">        the climatological mean and standard deviation represent a shorter period, interpretation of results may vary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean : Climatology</span>
<span class="sd">            The long-term climatological mean to calculate anomalies from. The climatological frequency and reducer will</span>
<span class="sd">            be determined from this climatology.</span>
<span class="sd">        std : Optional[Climatology]</span>
<span class="sd">            The long-term climatological standard deviation to calculate anomalies from. If provided, standardized</span>
<span class="sd">            climatological anomalies will be calculated. The climatological standard deviation frequency and reducer must</span>
<span class="sd">            match the frequency and reducer used by the climatological mean.</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the aggregated images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_mean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.time_series.TimeSeries</span>
<span class="sd">            Climatological anomalies within the TimeSeries period.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the :code:`std` frequency or reducer do not match the :code:`mean` frequency or reducer. Only applies if</span>
<span class="sd">            a :code:`std` is provided.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; collection = wxee.TimeSeries(&quot;IDAHO_EPSCOR/GRIDMET&quot;)</span>
<span class="sd">        &gt;&gt;&gt; reference = collection.filterDate(&quot;1980&quot;, &quot;2010&quot;)</span>
<span class="sd">        &gt;&gt;&gt; mean = reference.climatology_mean(&quot;month&quot;)</span>
<span class="sd">        &gt;&gt;&gt; std = reference.climatology_std(&quot;month&quot;)</span>
<span class="sd">        &gt;&gt;&gt; observation = collection.filterDate(&quot;2020&quot;, &quot;2021&quot;)</span>
<span class="sd">        &gt;&gt;&gt; anomaly = observation.climatology_anomaly(mean, std)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reducer</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">reducer</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">frequency</span>

        <span class="k">if</span> <span class="n">std</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">std</span><span class="o">.</span><span class="n">frequency</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Mean frequency &#39;</span><span class="si">{</span><span class="n">mean</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; does not match std frequency &#39;</span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">frequency</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">std</span><span class="o">.</span><span class="n">reducer</span> <span class="o">!=</span> <span class="n">mean</span><span class="o">.</span><span class="n">reducer</span><span class="p">:</span>
                <span class="c1"># There is no way to determine the type of reducer used after the fact, or else I would list them.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean reducer does not match std reducer.&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">image_anomaly</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Identify the climatological mean and std deviation for a given image</span>
<span class="sd">            and use them to calculate and return the anomaly.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get the climatological coordinate of the image</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">freq</span><span class="o">.</span><span class="n">date_format</span>
            <span class="p">)</span>

            <span class="c1"># Get the climatological mean at that coordinate</span>
            <span class="n">coord_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">filterMetadata</span><span class="p">(</span><span class="s2">&quot;wx:coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>

            <span class="n">anom</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">coord_mean</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

            <span class="c1"># If a standard deviation is provided, standardize the anomalies</span>
            <span class="k">if</span> <span class="n">std</span><span class="p">:</span>
                <span class="n">coord_std</span> <span class="o">=</span> <span class="n">std</span><span class="o">.</span><span class="n">filterMetadata</span><span class="p">(</span><span class="s2">&quot;wx:coordinate&quot;</span><span class="p">,</span> <span class="s2">&quot;equals&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
                <span class="n">anom</span> <span class="o">=</span> <span class="n">anom</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">coord_std</span><span class="o">.</span><span class="n">first</span><span class="p">())</span>

            <span class="n">anom</span> <span class="o">=</span> <span class="n">anom</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">())</span>

            <span class="c1"># This permits sparse mean and std climatologies, e.g. those with a start and end set.</span>
            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">coord_mean</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">anom</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_time</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">reducer</span><span class="p">,</span> <span class="n">keep_bandnames</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">collection</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">image_anomaly</span><span class="p">,</span> <span class="n">opt_dropNulls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TimeSeries.interpolate_time"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.interpolate_time">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Use interpolation to synthesize data at a given time within the time series. Based on the</span>
<span class="sd">        interpolation method chosen, a certain number of images must be present in the time series</span>
<span class="sd">        before and after the target date.</span>

<span class="sd">        Nearest and linear interpolation require 1 image before and after the selected time while</span>
<span class="sd">        cubic interpolation requires 2 images before and after the selected time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date : ee.Date</span>
<span class="sd">            The target date to interpolate data at. This must be within the time series period.</span>
<span class="sd">        method : str, default linear</span>
<span class="sd">            The interpolation method to use, one of &quot;nearest&quot;, &quot;linear&quot;, or &quot;cubic&quot;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ee.Image</span>
<span class="sd">            Data interpolated to the target time from surrounding data in the time series.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; ts = wxee.TimeSeries(&quot;IDAHO_EPSCOR/GRIDMET&quot;)</span>
<span class="sd">        &gt;&gt;&gt; target_date = ee.Date(&quot;2020-09-08T03&quot;)</span>
<span class="sd">        &gt;&gt;&gt; filled = ts.interpolate(target_date, &quot;cubic&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_func</span> <span class="o">=</span> <span class="n">get_interpolation_method</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

        <span class="n">y1</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_images_before</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_n_images_after</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Number</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">]]</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">_normalize</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">(),</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">]:</span>
            <span class="n">interpolated</span> <span class="o">=</span> <span class="n">method_func</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cubic&quot;</span><span class="p">:</span>
            <span class="n">interpolated</span> <span class="o">=</span> <span class="n">method_func</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>

        <span class="n">interpolated</span> <span class="o">=</span> <span class="n">interpolated</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">millis</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">interpolated</span></div>

    <span class="k">def</span> <span class="nf">_get_n_images_before</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get n images before a given date (inclusive) in the time series. The images will be selected</span>
<span class="sd">        and returned in a list in order of their proximity to the target date.&quot;&quot;&quot;</span>
        <span class="n">before_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;second&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
            <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">opt_ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">before_list</span> <span class="o">=</span> <span class="n">before_imgs</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">before_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_n_images_after</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get n images after a given date (inclusive) in the time series. The images will be selected</span>
<span class="sd">        and returned in order of their proximity to the target date.&quot;&quot;&quot;</span>
        <span class="n">after_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;second&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
            <span class="s2">&quot;system:time_start&quot;</span><span class="p">,</span> <span class="n">opt_ascending</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">after_list</span> <span class="o">=</span> <span class="n">after_imgs</span><span class="o">.</span><span class="n">toList</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">after_list</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>

<div class="viewcode-block" id="TimeSeries.insert_image"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.insert_image">[docs]</a>    <span class="k">def</span> <span class="nf">insert_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimeSeries&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Insert an image into the time series and sort it by :code:`system:time_start`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        img : ee.Image</span>
<span class="sd">            The image to insert.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.TimeSeries</span>
<span class="sd">            The time series with the image inserted in time order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">img</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">ImageCollection</span><span class="p">(</span><span class="n">merged</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">merged</span><span class="o">.</span><span class="n">wx</span><span class="o">.</span><span class="n">to_time_series</span><span class="p">()</span></div>

<div class="viewcode-block" id="TimeSeries.rolling_time"><a class="viewcode-back" href="../../wxee.html#wxee.time_series.TimeSeries.rolling_time">[docs]</a>    <span class="k">def</span> <span class="nf">rolling_time</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">align</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">reducer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_bandnames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;TimeSeries&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Apply a rolling reducer over the time dimension. Rolling windows are calculated around each image,</span>
<span class="sd">        so if images are irregularly spaced in time, the windows will be as well. As long as the minimum</span>
<span class="sd">        observations are met in each window, the output time series will contain the same number of images as</span>
<span class="sd">        the input, with each image reduced over its surrounding window.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        window : int</span>
<span class="sd">            The number of time units to include in each rolling period.</span>
<span class="sd">        unit : str</span>
<span class="sd">            The time frequency of the window. One of &quot;hour&quot;, &quot;day&quot;, &quot;week&quot;, &quot;month&quot;, &quot;year&quot;.</span>
<span class="sd">        align : str, default &quot;left&quot;</span>
<span class="sd">            The start location of the rolling window, relative to the primary image time. One of &quot;left&quot;, &quot;center&quot;,</span>
<span class="sd">            &quot;right&quot;. For example, a 3-day left-aligned window will include all images up to (but not including)</span>
<span class="sd">            3 days prior to the primary image. Date ranges are exclusive in the alignment direction and inclusive</span>
<span class="sd">            in the opposite direction, so each primary image will be included in its own window.</span>
<span class="sd">        min_observations : int, default 1</span>
<span class="sd">            The minimum number of images to include in the rolling window (counting the primary image). If the</span>
<span class="sd">            minimum observations are not met, the primary image will be dropped. For example, a monthly time series</span>
<span class="sd">            reduced with a 10 day window and :code:`min_observations==3` would be empty because none of the</span>
<span class="sd">            windows would include enough observations.</span>
<span class="sd">        reducer: Optional[ee.Reducer]</span>
<span class="sd">            The reducer to apply to each rolling window. If none is given, ee.Reducer.mean will be used.</span>
<span class="sd">        keep_bandnames : bool, default True</span>
<span class="sd">            If true, the band names of the input images will be kept in the reduced images. If false, the name of the</span>
<span class="sd">            reducer will be appended to the band names, e.g. SR_B4 will become SR_B4_mean.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        wxee.time_series.TimeSeries</span>
<span class="sd">            The time series with the rolling reducer applied to each image.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; ts = wxee.TimeSeries(&quot;MODIS/006/MOD13A2)</span>
<span class="sd">        &gt;&gt;&gt; ts_smooth = ts.rolling_time(90, &quot;day&quot;, &quot;center&quot;, reducer=ee.Reducer.median())</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reducer</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Reducer</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">reducer</span> <span class="k">else</span> <span class="n">reducer</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="k">else</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">nudge</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s2">&quot;center&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">def</span> <span class="nf">roll_image</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;Apply a rolling reducer to a single image using its temporal neighbors&quot;&quot;&quot;</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system:time_start&quot;</span><span class="p">))</span>
            <span class="c1"># The windows need to be nudged slightly to set the correct exclusive/inclusive order.</span>
            <span class="c1"># For example, a left aligned window should exclude the left and include the right,</span>
            <span class="c1"># and vice-versa for a right aligned window.</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">center</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">window</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">nudge</span><span class="p">,</span> <span class="s2">&quot;second&quot;</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>

            <span class="n">neighbors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filterDate</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">reducer</span><span class="p">)</span>

            <span class="n">props</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;wx:window_size&quot;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span>
                <span class="s2">&quot;wx:window_unit&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                <span class="s2">&quot;wx:window_align&quot;</span><span class="p">:</span> <span class="n">align</span><span class="p">,</span>
                <span class="s2">&quot;wx:window_includes&quot;</span><span class="p">:</span> <span class="n">neighbors</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span>
            <span class="p">}</span>
            <span class="n">smooth</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span>
                <span class="n">smooth</span><span class="o">.</span><span class="n">copyProperties</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">propertyNames</span><span class="p">())</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">keep_bandnames</span><span class="p">:</span>
                <span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">bandNames</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">ee</span><span class="o">.</span><span class="n">Algorithms</span><span class="o">.</span><span class="n">If</span><span class="p">(</span><span class="n">neighbors</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">min_observations</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">roll_image</span><span class="p">,</span> <span class="n">opt_dropNulls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Aaron Zuspan.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>